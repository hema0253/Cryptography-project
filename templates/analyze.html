{% extends "base.html" %}

{% block title %}Analyze - Network Security Analysis{% endblock %}

{% block extra_css %}
<style>
    .json-editor {
        height: 300px;
        font-family: monospace;
    }
    #result-container {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h1 class="display-5">Network Packet Analysis</h1>
        <p class="lead">Submit network packet data for analysis</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Submit Packet Data</h5>
            </div>
            <div class="card-body">
                <form id="analyze-form">
                    <div class="mb-3">
                        <label for="identity" class="form-label">Identity</label>
                        <input type="text" class="form-control" id="identity" required>
                        <div class="form-text">Your identity string for authentication</div>
                    </div>
                    <div class="mb-3">
                        <label for="hash" class="form-label">Hash</label>
                        <input type="text" class="form-control" id="hash" required>
                        <div class="form-text">Authentication hash</div>
                    </div>
                    <div class="mb-3">
                        <label for="packet-data" class="form-label">Packet Data (JSON)</label>
                        <textarea class="form-control json-editor" id="packet-data" required></textarea>
                        <div class="form-text">Enter packet features in JSON format</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Analyze Packet</button>
                    <button type="button" class="btn btn-secondary" id="sample-data-btn">Load Sample Data</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4" id="result-container">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">Analysis Results</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info" id="status-message"></div>
                <div id="prediction-container">
                    <h5>Prediction:</h5>
                    <div class="p-3 border rounded mb-3" id="prediction-result"></div>
                    
                    <h5>Confidence:</h5>
                    <div class="progress mb-3">
                        <div class="progress-bar" id="confidence-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <h5>Details:</h5>
                    <pre id="result-details" class="p-3 border rounded bg-light"></pre>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">How to Use</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>Enter your identity string (any username)</li>
                    <li>Generate a hash using our algorithm (or click "Load Sample Data")</li>
                    <li>Enter packet features in JSON format</li>
                    <li>Click "Analyze Packet" to get results</li>
                </ol>
                <p>For API integration, send a POST request to <code>/analyze</code> with the required JSON payload.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const analyzeForm = document.getElementById('analyze-form');
        const sampleDataBtn = document.getElementById('sample-data-btn');
        const resultContainer = document.getElementById('result-container');
        const statusMessage = document.getElementById('status-message');
        const predictionResult = document.getElementById('prediction-result');
        const confidenceBar = document.getElementById('confidence-bar');
        const resultDetails = document.getElementById('result-details');
        
        // Sample data for demonstration
        const sampleData = {
            identity: "test_user",
            hash: "a1b2c3d4e5f6g7h8i9j0",
            packet: {
                duration: 0,
                protocol_type: "tcp",
                service: "http",
                flag: "SF",
                src_bytes: 215,
                dst_bytes: 45076,
                land: 0,
                wrong_fragment: 0,
                urgent: 0,
                hot: 0,
                num_failed_logins: 0,
                logged_in: 1,
                num_compromised: 0,
                root_shell: 0,
                su_attempted: 0,
                num_root: 0,
                num_file_creations: 0,
                num_shells: 0,
                num_access_files: 0,
                num_outbound_cmds: 0,
                is_host_login: 0,
                is_guest_login: 0,
                count: 1,
                srv_count: 1,
                serror_rate: 0,
                srv_serror_rate: 0,
                rerror_rate: 0,
                srv_rerror_rate: 0,
                same_srv_rate: 1,
                diff_srv_rate: 0,
                srv_diff_host_rate: 0,
                dst_host_count: 255,
                dst_host_srv_count: 1,
                dst_host_same_srv_rate: 0.00,
                dst_host_diff_srv_rate: 0.03,
                dst_host_same_src_port_rate: 0.00,
                dst_host_srv_diff_host_rate: 0.00,
                dst_host_serror_rate: 0.00,
                dst_host_srv_serror_rate: 0.00,
                dst_host_rerror_rate: 0.00,
                dst_host_srv_rerror_rate: 0.00
            }
        };
        
        // Load sample data
        sampleDataBtn.addEventListener('click', function() {
            document.getElementById('identity').value = sampleData.identity;
            document.getElementById('hash').value = sampleData.hash;
            document.getElementById('packet-data').value = JSON.stringify(sampleData.packet, null, 2);
        });
        
        // Handle form submission
        analyzeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const identity = document.getElementById('identity').value;
            const hash = document.getElementById('hash').value;
            let packet;
            
            try {
                packet = JSON.parse(document.getElementById('packet-data').value);
            } catch (error) {
                alert('Invalid JSON format for packet data');
                return;
            }
            
            // Show loading state
            resultContainer.style.display = 'block';
            statusMessage.textContent = 'Analyzing packet data...';
            statusMessage.className = 'alert alert-info';
            
            // Simulate API call (in a real app, this would be an actual fetch to your API)
            setTimeout(() => {
                // For demo purposes, we'll simulate a successful response
                const response = {
                    status: 'ok',
                    prediction: Math.random() > 0.7 ? 'Malicious' : 'Normal',
                    confidence: Math.random() * 100,
                    details: {
                        attack_type: Math.random() > 0.7 ? 'DoS' : 'None',
                        features_analyzed: 41,
                        timestamp: new Date().toISOString()
                    }
                };
                
                // Update UI with results
                statusMessage.textContent = `Analysis complete: ${response.status}`;
                statusMessage.className = 'alert alert-success';
                
                predictionResult.textContent = response.prediction;
                predictionResult.className = response.prediction === 'Malicious' ? 
                    'p-3 border rounded bg-danger text-white' : 
                    'p-3 border rounded bg-success text-white';
                
                confidenceBar.style.width = `${response.confidence}%`;
                confidenceBar.textContent = `${response.confidence.toFixed(2)}%`;
                confidenceBar.className = response.prediction === 'Malicious' ? 
                    'progress-bar bg-danger' : 'progress-bar bg-success';
                
                resultDetails.textContent = JSON.stringify(response.details, null, 2);
            }, 1500);
        });
    });
</script>
{% endblock %}